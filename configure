#!/bin/bash

function make_cmake_list(){
	rm CMakeLists.txt
	if [ $1 = "*" ]; then
		echo "No child folder found!"
	else
		for name in $*
			do
			if [ $name = "CMakeLists.txt" ]; then
				echo "Skip CMakeLists.txt"
			else
				echo "Adding dir: " $name
				echo -ne "add_subdirectory("$name")\n" >> CMakeLists.txt
			fi
			done
	fi
}

function print_usage(){
	echo "Usage:"
	echo -ne "\n./configure [-g|--generator GeneratorName] [-f|--folder FolderName] [-b|--build BuildType]"
	echo -ne " [-p|--param ParamName] [-d|--documentation full/fast] [-h|--help]"
	echo -ne " [-e|--extern-path ExternPath] [-E|--extern-abs-path ExternAbsPath]"
	echo -ne " [-t|--enable-testing] [--test-name name] [--test-site addr]\n"
	echo -ne "Options:\n"
	echo "[-g|--generator GeneratorName]: Specify the cmake generator - default cmake's default"
	echo "[-f|--folder-name FolderName]: Specify the build folder name - default is the generator name or the build type if the generator was not specified"
	echo "[-F|--folder-path FolderPath]: Specify the build folder path - unlike the build folder-name wich creates a folder under build, this flag allows creating a build folder anywhere"
	echo "[-b|--build BuildType]: The cmake build type release/debug/nolog/maintain - default release"
	echo "[-p|--param ParamName]: Extra compilation flags. E.g. -p \"-DUINDEX64 -DUSERVICEBITS=3\""
	echo "[-d|--documentation full/fast]: Build either fast or full documentation"
#	echo "[-e|--extern-path ExternPath]: relative path to extern libraries under solidground/extern folder"
	echo "[-e|--extern-path ExternAbsPath]: absolute path to extern libraries"
	echo "[-t|--enable-testing]: Enable unit-testing using ctest"
	echo "[--test-name name]: The name of ctest/cdash project"
	echo "[--test-site addr]: The address for cdash drop site"
	echo "[--generator-param]: Some parameters given to cmake like: -DECLIPSE_CDT4_GENERATE_SOURCE_PROJECT=TRUE"
	echo
	echo "Examples:"
	echo "1) create simple make release build:"
	echo "	./configure -f rls -b release -e ~/work/sg_extern"
	echo "2) create kdevelop3 project:"
	echo "	./configure -f kdv -b debug -e ~/work/sg_extern -g KDevelop3"
	echo "3) create eclipse projects - one for source within source tree and one external for build (note that the build is external to source tree, as needed by eclipse):"
	echo "	./configure -F ../sg_ecl -b debug -e ~/work/sg_extern -g \"Eclipse CDT4 - Unix Makefiles\" --generator-param \"-DECLIPSE_CDT4_GENERATE_SOURCE_PROJECT=TRUE\""
	echo
	exit
}

# if [ "$1" = "" ] ; then
# 	print_usage
# fi

# First define and initilaize the variables

GENERATOR=
GPARAM=
DOCUMENTATION=
BUILD_TYPE=
FOLDER_NAME=
FOLDER_PATH=
HELP="no"
PARAM=
EXTERN_PATH=
EXTERN_ABS_PATH=
ENABLE_TESTING=
TEST_NAME=
TEST_SITE=

while [ "$#" -gt 0 ]; do
	CURRENT_OPT="$1"
	UNKNOWN_ARG=no
	case "$1" in
	-g|--generator)
		shift
		GENERATOR=$1
		;;
	-f|--folder-name)
		shift
		FOLDER_NAME=$1
		;;
	-F|--folder-path)
		shift
		FOLDER_PATH=$1
		;;
	-b|--build)
		shift
		BUILD_TYPE=$1
		;;
	-d|--documentation)
		if [ -z "$2" ] || echo "$2" | grep '^-' >/dev/null 2>&1; then
			DOCUMENTATION="fast"
		else
			shift;
			DOCUMENTATION=$1
		fi
		;;
	-p|--param)
		shift
		PARAM=$PARAM"$1 "
		;;
	--generator-param)
		shift
		GPARAM=$GPARAM"$1 "
		;;
#	-e|--extern-path)
#		if [ -z "$2" ] || echo "$2" | grep '^-' >/dev/null 2>&1; then
#			EXTERN_PATH="extern"
#		else
#			shift;
#			EXTERN_PATH=$1
#		fi
#		;;
	-e|--extern-path)
		if [ -z "$2" ] || echo "$2" | grep '^-' >/dev/null 2>&1; then
			EXTERN_ABS_PATH=""
		else
			shift;
			EXTERN_ABS_PATH=$1
		fi
		;;

	-h|--help)
		HELP="yes"
		;;
	-t|--enable-testing)
		ENABLE_TESTING="yes"
		;;
	--test-name)
		shift
		TEST_NAME="$1"
		;;
	--test-site)
		shift
		TEST_SITE="$1"
		;;
	*)
		HELP="yes"
		;;
	esac
	shift
done


#echo "generator = $GENERATOR"
#echo "folder = $FOLDER_NAME"
#echo "build = $BUILD_TYPE"
#echo "documentation = $DOCUMENTATION"
#echo "parameters = $PARAM"
#echo "help = $HELP"
#echo "extern = $EXTERN"

if [ "$HELP" = "yes" ]; then
	print_usage
	exit
fi

if [ "$DOCUMENTATION" = "full" ]; then
	echo "Building full documentation ..."
	rm -rf documentation/html/
	rm -rf documentation/latex/
	doxygen
	tar -cjf documentation/full.tar.bz2 documentation/html/ documentation/index.html
	echo "Done building full documentation"
	exit
fi

if [ "$DOCUMENTATION" = "fast" ]; then
	echo "Building documentation..."
	rm -rf documentation/html/
	doxygen Doxyfile.fast
	tar -cjf documentation/fast.tar.bz2 documentation/html/ documentation/index.html
	echo "Done building documentation"
	exit
fi

# if [ "$EXTERN" = "pack" ]; then
# 	echo "Building extern archive"
# 	cd extern
# 	tar -cjf solidground_extern_linux.tar.bz2 linux
# 	echo "Done building extern archive"
# fi


if [ "$BUILD_TYPE" = "" ]; then
	BUILD_TYPE="release"
fi

if [ "$FOLDER_NAME" = "" ]; then
	if [ "$GENERATOR" = "" ]; then
		FOLDER_NAME=$BUILD_TYPE
	else
		FOLDER_NAME=$GENERATOR
	fi
fi


echo "Configure an out-of-source build configuration of type $BUILD_TYPE on folder build/$FOLDER_NAME and params $PARAM"
cd application
make_cmake_list *
cd ../

cd library
make_cmake_list *
cd ../

SRC_PATH="`pwd`"

if [ "$FOLDER_PATH" = "" ]; then
	mkdir build
	mkdir "build/$FOLDER_NAME"
	cd "build/$FOLDER_NAME"
else
	echo "$FOLDER_PATH"
	mkdir "$FOLDER_PATH"
	cd "$FOLDER_PATH"
fi
echo $GENERATOR

if [ "$GENERATOR" = "" ]; then
	echo "Using cmake's default generator"
	cmake -DCMAKE_BUILD_TYPE=$BUILD_TYPE -DUDEFS:STRING="$PARAM" -DUEXTERN:STRING="$EXTERN_PATH" -DUEXTERN_ABS:STRING="$EXTERN_ABS_PATH" -DUTESTING:STRING="$ENABLE_TESTING" -DUTEST_NAME="$TEST_NAME" -DUTEST_SITE="$TEST_SITE" "$SRC_PATH"
	echo "./configure -f $FOLDER_NAME -F $FOLDER_PATH -b $BUILD_TYPE -p \"$PARAM\" -e \"$EXTERN_ABS_PATH\" -DUTESTING:STRING=\"$ENABLE_TESTING\" -DUTEST_NAME=\"$TEST_NAME\" -DUTEST_SITE=\"$TEST_SITE\"" > configure.txt
	echo "Done!"
else
	echo "Using cmake's $GENERATOR with $GPARAM"
	cmake -G "$GENERATOR" $GPARAM -DCMAKE_BUILD_TYPE=$BUILD_TYPE -DUDEFS:STRING="$PARAM" -DUEXTERN:STRING="$EXTERN_PATH" -DUEXTERN_ABS:STRING="$EXTERN_ABS_PATH" -DUTESTING:STRING="$ENABLE_TESTING" -DUTEST_NAME="$TEST_NAME" -DUTEST_SITE="$TEST_SITE" "$SRC_PATH"
	echo "./configure -f $FOLDER_NAME -F $FOLDER_PATH -g \"$GENERATOR\" -b $BUILD_TYPE -p \"$PARAM\" -e \"$EXTERN_ABS_PATH\" -DUTESTING:STRING=\"$ENABLE_TESTING\" -DUTEST_NAME=\"$TEST_NAME\" -DUTEST_SITE=\"$TEST_SITE\"" > configure.txt
fi

exit

# case "$1" in
# 	"kdevelop")
# 		if [ "$2" = "" ] ; then
# 			print_usage
# 		else
# 			echo "Building KDevelop project ..."
# 			cd application
# 			make_cmake_list *
# 			cd ../
# 
# 			cd library
# 			make_cmake_list *
# 			cd ../
# 
# 			mkdir build
# 			mkdir "build/$1"
# 			cd "build/$1"
# 			cmake -G KDevelop3 -DCMAKE_BUILD_TYPE=$2 -DUDEFS="$3" ../../
# 			echo "Done building KDevelop project"
# 		fi
# 		;;
# 	"documentation_full")
# 		echo "Building full documentation ..."
# 		rm -rf documentation/html/
# 		rm -rf documentation/latex/
# 		doxygen
# 		tar -cjf documentation/full.tar.bz2 documentation/html/ documentation/index.html
# 		echo "Done building full documentation"
# 		;;
# 	"documentation_fast")
# 		echo "Building documentation..."
# 		rm -rf documentation/html/
# 		doxygen Doxyfile.fast
# 		tar -cjf documentation/fast.tar.bz2 documentation/html/ documentation/index.html
# 		echo "Done building documentation"
# 		;;
# 	"extern")
# 		echo "Building extern archive"
# 		cd extern
# 		tar -cjf solidground_extern_linux.tar.bz2 linux
# 		echo "Done building extern archive"
# 		;;
# 	*)
# 		THEFLD="$2"
# 		echo $THEFLD
# 		if [ "$THEFLD" = "" ] ; then
# 			THEFLD="$1"
# 		fi
# 		cd application
# 		make_cmake_list *
# 		cd ../
# 
# 		cd library
# 		make_cmake_list *
# 		cd ../
# 		echo "Preparing build/$THEFLD for $1 build type with \"$3\" parameters..."
# 		mkdir build
# 		mkdir "build/$THEFLD"
# 		cd "build/$THEFLD"
# 		cmake -DCMAKE_BUILD_TYPE=$1 -DUDEFS:STRING="$3" ../../
# 		echo "Done preparing build/$THEFLD for $1 build type with \"$3\" parameters"
# 		;;
# esac
